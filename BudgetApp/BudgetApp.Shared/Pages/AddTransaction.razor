@page "/add"
@page "/edit/{TransactionId:int}"
@inject IBudgetService BudgetService
@inject NavigationManager Navigation

<PageTitle>@(IsEditing ? "Edit" : "Add") Transaction</PageTitle>

<div class="add-transaction">
    <!-- Header -->
    <div class="header">
        <button class="back-btn" @onclick="GoBack">‚Üê</button>
        <h1 class="header-title">@(IsEditing ? "Edit" : "Add") Transaction</h1>
        <div class="header-spacer"></div>
    </div>

    <!-- Transaction Type Toggle -->
    <div class="type-toggle">
        <button class="type-btn @(IsExpense ? "active" : "")" @onclick="() => IsExpense = true">
            Expense
        </button>
        <button class="type-btn @(!IsExpense ? "active income" : "")" @onclick="() => IsExpense = false">
            Income
        </button>
    </div>

    <!-- Amount Input -->
    <div class="amount-section">
        <span class="currency-symbol">$</span>
        <input type="number" 
               class="amount-input" 
               placeholder="0.00" 
               step="0.01" 
               min="0"
               @bind="Amount" 
               @bind:event="oninput" />
    </div>

    <!-- Form Fields -->
    <div class="form-section">
        <!-- Description -->
        <div class="form-field">
            <label class="field-label">Description</label>
            <input type="text" 
                   class="field-input" 
                   placeholder="@(IsExpense ? "What was this for?" : "e.g., Bonus, Side gig, Gift")"
                   @bind="Description" />
        </div>

        <!-- Category (only for expenses) -->
        @if (IsExpense)
        {
            <div class="form-field">
                <label class="field-label">Category</label>
                <div class="category-grid">
                    @foreach (var category in Categories)
                    {
                        <button type="button"
                                class="category-chip @(SelectedCategoryId == category.Id ? "selected" : "")"
                                style="@(SelectedCategoryId == category.Id ? $"background-color: {category.Color}; border-color: {category.Color};" : "")"
                                @onclick="() => SelectedCategoryId = category.Id">
                            <span class="chip-icon">@category.Icon</span>
                            <span class="chip-name">@category.Name</span>
                        </button>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="income-hint">
                <span class="hint-icon">üí°</span>
                <span class="hint-text">Recording additional income beyond your monthly budget</span>
            </div>
        }

        <!-- Date -->
        <div class="form-field">
            <label class="field-label">Date</label>
            <input type="date" 
                   class="field-input" 
                   @bind="TransactionDate" />
        </div>
    </div>

    <!-- Save Button -->
    <div class="save-section">
        <button class="save-btn @(!IsValid ? "disabled" : "")" 
                @onclick="SaveTransaction" 
                disabled="@(!IsValid)">
            @(IsEditing ? "Update" : "Save") Transaction
        </button>
    </div>

    <div class="bottom-spacer"></div>
</div>

@code {
    [Parameter]
    public int? TransactionId { get; set; }

    private bool IsEditing => TransactionId.HasValue;
    private bool IsExpense { get; set; } = true;
    private decimal Amount { get; set; }
    private string Description { get; set; } = string.Empty;
    private int SelectedCategoryId { get; set; }
    private DateTime TransactionDate { get; set; } = DateTime.Today;
    private List<Category> Categories { get; set; } = new();
    private string? ReturnUrl { get; set; }

    // For expenses: need amount and category. For income: just need amount and description
    private bool IsValid => Amount > 0 && (IsExpense ? SelectedCategoryId > 0 : !string.IsNullOrWhiteSpace(Description));

    protected override void OnInitialized()
    {
        Categories = BudgetService.GetCategories();
        
        // Check for returnUrl query parameter
        var uri = new Uri(Navigation.Uri);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            var returnUrlParam = queryParams["returnUrl"];
            if (!string.IsNullOrEmpty(returnUrlParam))
            {
                ReturnUrl = returnUrlParam;
            }
        }
        
        if (IsEditing)
        {
            // Load existing transaction
            var transaction = BudgetService.GetTransaction(TransactionId!.Value);
            if (transaction != null)
            {
                Amount = transaction.Amount;
                Description = transaction.Description;
                SelectedCategoryId = transaction.CategoryId;
                TransactionDate = transaction.Date;
                IsExpense = transaction.Type == TransactionType.Expense;
                
                // Only set return URL if not already set from query param
                if (string.IsNullOrEmpty(ReturnUrl))
                {
                    ReturnUrl = transaction.CategoryId > 0 
                        ? $"/category/{transaction.CategoryId}" 
                        : "/";
                }
            }
        }
        else if (Categories.Any())
        {
            SelectedCategoryId = Categories.First().Id;
        }
    }

    private void GoBack()
    {
        Navigation.NavigateTo(ReturnUrl ?? "/");
    }

    private void SaveTransaction()
    {
        if (!IsValid) return;

        // For expenses, use category name as default description if empty
        // For income, description is required so it will always have a value
        var description = string.IsNullOrWhiteSpace(Description) && IsExpense
            ? Categories.FirstOrDefault(c => c.Id == SelectedCategoryId)?.Name ?? "Expense"
            : Description;

        if (IsEditing)
        {
            var transaction = new Transaction
            {
                Id = TransactionId!.Value,
                Description = description,
                Amount = Amount,
                Date = TransactionDate,
                CategoryId = IsExpense ? SelectedCategoryId : 0, // Income has no category
                Type = IsExpense ? TransactionType.Expense : TransactionType.Income
            };
            BudgetService.UpdateTransaction(transaction);
        }
        else
        {
            var transaction = new Transaction
            {
                Description = description,
                Amount = Amount,
                Date = TransactionDate,
                CategoryId = IsExpense ? SelectedCategoryId : 0, // Income has no category
                Type = IsExpense ? TransactionType.Expense : TransactionType.Income
            };
            BudgetService.AddTransaction(transaction);
        }

        Navigation.NavigateTo(ReturnUrl ?? "/");
    }
}
