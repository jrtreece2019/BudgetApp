@page "/transactions"
@inject IBudgetService BudgetService
@inject NavigationManager Navigation

<PageTitle>All Transactions</PageTitle>

<div class="transactions-page">
    <!-- Header -->
    <div class="header">
        <button class="back-btn" @onclick="GoBack">‚Üê</button>
        <h1 class="header-title">All Transactions</h1>
        <div class="header-spacer"></div>
    </div>

    <!-- Search & Filters -->
    <div class="filters-section">
        <div class="search-box">
            <span class="search-icon">üîç</span>
            <input type="text" 
                   class="search-input" 
                   placeholder="Search transactions..."
                   @bind="SearchQuery"
                   @bind:event="oninput" />
            @if (!string.IsNullOrEmpty(SearchQuery))
            {
                <button class="clear-btn" @onclick="ClearSearch">‚úï</button>
            }
        </div>

        <div class="filter-row">
            <select class="filter-select" @bind="SelectedCategoryId">
                <option value="0">All Categories</option>
                <option value="-1">üí∞ Income</option>
                @foreach (var category in Categories)
                {
                    <option value="@category.Id">@category.Icon @category.Name</option>
                }
            </select>
        </div>
    </div>

    <!-- Month Navigation -->
    <div class="month-nav">
        <button class="month-btn" @onclick="PreviousMonth">‚Äπ</button>
        <span class="month-title">@CurrentDate.ToString("MMMM yyyy")</span>
        <button class="month-btn" @onclick="NextMonth">‚Ä∫</button>
    </div>

    <!-- Summary -->
    <div class="summary-row">
        <div class="summary-item">
            <span class="summary-label">Expected</span>
            <span class="summary-value">@ExpectedIncome.ToString("C0")</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Received</span>
            <span class="summary-value income">@ActualIncome.ToString("C0")</span>
            <span class="summary-detail">@PaycheckCount paycheck@(PaycheckCount != 1 ? "s" : "")</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Spent</span>
            <span class="summary-value expense">@TotalExpenses.ToString("C0")</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Remaining</span>
            <span class="summary-value @(NetAmount >= 0 ? "income" : "expense")">@NetAmount.ToString("C0")</span>
        </div>
    </div>

    <!-- Transactions List -->
    <div class="section">
        @if (FilteredTransactions.Any())
        {
            <div class="section-header">
                <span class="section-title">@FilteredTransactions.Count transactions</span>
            </div>
            <div class="transaction-list">
                @foreach (var transaction in FilteredTransactions)
                {
                    var txnId = transaction.Id;
                    var category = Categories.FirstOrDefault(c => c.Id == transaction.CategoryId);
                    var isIncome = transaction.Type == TransactionType.Income;

                    <div class="transaction-item">
                        <div class="transaction-main" @onclick="() => EditTransaction(txnId)">
                            <div class="transaction-icon" style="background-color: @(category?.Color ?? "#6B7280")">
                                @(category?.Icon ?? "üí∞")
                            </div>
                            <div class="transaction-info">
                                <span class="transaction-desc">@transaction.Description</span>
                                <span class="transaction-meta">
                                    @(category?.Name ?? (isIncome ? "Income" : "Unknown")) ¬∑ @FormatDate(transaction.Date)
                                </span>
                            </div>
                            <div class="transaction-amount @(isIncome ? "income" : "expense")">
                                @(isIncome ? "+" : "-")@transaction.Amount.ToString("C2")
                            </div>
                        </div>
                        <button class="delete-btn" @onclick="() => DeleteTransaction(txnId)" @onclick:stopPropagation="true">
                            üóëÔ∏è
                        </button>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <div class="empty-icon">üìã</div>
                <p class="empty-text">No transactions found</p>
                @if (!string.IsNullOrEmpty(SearchQuery) || SelectedCategoryId != 0)
                {
                    <button class="clear-filters-btn" @onclick="ClearFilters">Clear filters</button>
                }
            </div>
        }
    </div>

    <!-- Spacer for floating button -->
    <div class="bottom-spacer"></div>

    <!-- Floating Add Button -->
    <button class="fab" @onclick="AddTransaction">
        <span class="fab-icon">+</span>
    </button>
</div>

@code {
    private DateTime CurrentDate { get; set; } = DateTime.Now;
    private List<Category> Categories { get; set; } = new();
    private List<Transaction> AllTransactions { get; set; } = new();
    
    private string SearchQuery { get; set; } = string.Empty;
    private int SelectedCategoryId { get; set; }

    private List<Transaction> FilteredTransactions => AllTransactions
        .Where(t => string.IsNullOrEmpty(SearchQuery) || 
                    t.Description.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase))
        .Where(t => SelectedCategoryId == 0 || // All categories
                    (SelectedCategoryId == -1 && t.Type == TransactionType.Income) || // Income filter
                    t.CategoryId == SelectedCategoryId) // Specific category
        .OrderByDescending(t => t.Date)
        .ThenByDescending(t => t.Id)
        .ToList();

    private decimal TotalExpenses => FilteredTransactions
        .Where(t => t.Type == TransactionType.Expense)
        .Sum(t => t.Amount);

    // Expected vs Actual Income
    private decimal ExpectedIncome { get; set; }
    private decimal ActualIncome { get; set; }
    private int PaycheckCount { get; set; }

    private decimal NetAmount => ExpectedIncome - TotalExpenses;

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        Categories = BudgetService.GetCategories();
        AllTransactions = BudgetService.GetTransactions(CurrentDate.Month, CurrentDate.Year);
        
        // Expected income from setting
        ExpectedIncome = BudgetService.GetMonthlyIncome();
        
        // Actual income from paychecks
        var paychecks = AllTransactions.Where(t => t.Type == TransactionType.Income).ToList();
        ActualIncome = paychecks.Sum(t => t.Amount);
        PaycheckCount = paychecks.Count;
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        LoadData();
    }

    private void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        LoadData();
    }

    private void EditTransaction(int transactionId)
    {
        Navigation.NavigateTo($"/edit/{transactionId}?returnUrl=/transactions");
    }

    private void AddTransaction()
    {
        Navigation.NavigateTo("/add?returnUrl=/transactions");
    }

    private void DeleteTransaction(int transactionId)
    {
        BudgetService.DeleteTransaction(transactionId);
        LoadData();
    }

    private void ClearSearch()
    {
        SearchQuery = string.Empty;
    }

    private void ClearFilters()
    {
        SearchQuery = string.Empty;
        SelectedCategoryId = 0;
    }

    private string FormatDate(DateTime date)
    {
        if (date.Date == DateTime.Today)
            return "Today";
        if (date.Date == DateTime.Today.AddDays(-1))
            return "Yesterday";
        return date.ToString("MMM d");
    }
}

