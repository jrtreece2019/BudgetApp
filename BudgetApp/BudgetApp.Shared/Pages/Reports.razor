@page "/reports"
@inject IBudgetService BudgetService
@inject NavigationManager Navigation

<PageTitle>Reports</PageTitle>

<div class="reports-page">
    <!-- Header -->
    <div class="header">
        <button class="back-btn" @onclick="GoBack">←</button>
        <h1 class="header-title">Reports</h1>
        <div class="header-spacer"></div>
    </div>

    <!-- Month Navigation -->
    <div class="month-nav">
        <button class="month-btn" @onclick="PreviousMonth">‹</button>
        <span class="month-title">@CurrentDate.ToString("MMMM yyyy")</span>
        <button class="month-btn" @onclick="NextMonth">›</button>
    </div>

    <!-- Overview Cards -->
    <div class="overview-cards">
        <div class="overview-card expense">
            <span class="card-label">Total Spent</span>
            <span class="card-value">@TotalExpenses.ToString("C0")</span>
        </div>
        <div class="overview-card income">
            <span class="card-label">Total Income</span>
            <span class="card-value">@TotalIncome.ToString("C0")</span>
        </div>
    </div>

    <div class="net-card @(NetAmount >= 0 ? "positive" : "negative")">
        <span class="net-label">@(NetAmount >= 0 ? "You saved" : "You overspent")</span>
        <span class="net-value">@Math.Abs(NetAmount).ToString("C0")</span>
    </div>

    <!-- Spending by Category -->
    <div class="section">
        <div class="section-header">
            <span class="section-title">Spending by Category</span>
        </div>

        @if (CategorySpending.Any())
        {
            <div class="category-chart">
                @foreach (var item in CategorySpending.OrderByDescending(c => c.Amount))
                {
                    var percentage = TotalExpenses > 0 ? (double)(item.Amount / TotalExpenses) * 100 : 0;
                    
                    <div class="chart-row">
                        <div class="chart-label">
                            <span class="chart-icon" style="background-color: @item.Category.Color">@item.Category.Icon</span>
                            <span class="chart-name">@item.Category.Name</span>
                        </div>
                        <div class="chart-bar-container">
                            <div class="chart-bar" style="width: @percentage%; background-color: @item.Category.Color"></div>
                        </div>
                        <div class="chart-value">
                            <span class="chart-amount">@item.Amount.ToString("C0")</span>
                            <span class="chart-percent">@percentage.ToString("F0")%</span>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p class="empty-text">No spending data this month</p>
            </div>
        }
    </div>

    <!-- Budget Status -->
    <div class="section">
        <div class="section-header">
            <span class="section-title">Budget Status</span>
        </div>

        <div class="budget-list">
            @foreach (var item in CategorySpending.OrderByDescending(c => c.Amount))
            {
                var budget = BudgetService.GetBudgetByCategory(item.Category.Id, CurrentDate.Month, CurrentDate.Year);
                var percentage = budget > 0 ? Math.Min((double)(item.Amount / budget) * 100, 100) : 0;
                var isOver = item.Amount > budget;
                var remaining = budget - item.Amount;

                <div class="budget-item @(isOver ? "over" : "")">
                    <div class="budget-header">
                        <span class="budget-icon" style="background-color: @item.Category.Color">@item.Category.Icon</span>
                        <span class="budget-name">@item.Category.Name</span>
                        <span class="budget-status @(isOver ? "over" : "under")">
                            @if (isOver)
                            {
                                <span>@Math.Abs(remaining).ToString("C0") over</span>
                            }
                            else
                            {
                                <span>@remaining.ToString("C0") left</span>
                            }
                        </span>
                    </div>
                    <div class="budget-progress-container">
                        <div class="budget-progress-bar @(isOver ? "over" : "")" 
                             style="width: @percentage%; background-color: @(isOver ? "#f87171" : item.Category.Color)"></div>
                    </div>
                    <div class="budget-footer">
                        <span>@item.Amount.ToString("C0") of @budget.ToString("C0")</span>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Spacer -->
    <div class="bottom-spacer"></div>
</div>

@code {
    private DateTime CurrentDate { get; set; } = DateTime.Now;
    private List<Category> Categories { get; set; } = new();
    private List<Transaction> Transactions { get; set; } = new();
    private List<CategorySpendingItem> CategorySpending { get; set; } = new();

    private decimal TotalExpenses => Transactions
        .Where(t => t.Type == TransactionType.Expense)
        .Sum(t => t.Amount);

    private decimal TotalIncome => Transactions
        .Where(t => t.Type == TransactionType.Income)
        .Sum(t => t.Amount);

    private decimal NetAmount => TotalIncome - TotalExpenses;

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        Categories = BudgetService.GetCategories();
        Transactions = BudgetService.GetTransactions(CurrentDate.Month, CurrentDate.Year);
        
        CategorySpending = Categories
            .Select(c => new CategorySpendingItem
            {
                Category = c,
                Amount = Transactions
                    .Where(t => t.CategoryId == c.Id && t.Type == TransactionType.Expense)
                    .Sum(t => t.Amount)
            })
            .Where(c => c.Amount > 0)
            .ToList();
    }

    private void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    private void PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        LoadData();
    }

    private void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        LoadData();
    }

    private class CategorySpendingItem
    {
        public Category Category { get; set; } = null!;
        public decimal Amount { get; set; }
    }
}

