@page "/sinking-fund/new"
@page "/sinking-fund/{FundId:int}"

<div class="edit-fund-page">
    <header class="page-header">
        <button class="back-btn" @onclick="GoBack">← Back</button>
        <h1>@(IsNew ? "Create Sinking Fund" : "Edit Sinking Fund")</h1>
    </header>

    <div class="form-card">
        <!-- Name & Icon/Color -->
        <div class="form-section">
            <h3 class="section-title">Fund Details</h3>
            
            <div class="preview-row">
                <div class="fund-preview" style="background: @Fund.Color">@Fund.Icon</div>
                <div class="preview-name">@(string.IsNullOrWhiteSpace(Fund.Name) ? "New Fund" : Fund.Name)</div>
            </div>

            <div class="form-group">
                <label>Fund Name</label>
                <input type="text" @bind="Fund.Name" placeholder="e.g., Vacation, Car Repair, Holiday Gifts" />
            </div>

            <div class="form-group">
                <label>Icon</label>
                <IconPicker Options="Icons" @bind-SelectedValue="Fund.Icon" />
            </div>

            <div class="form-group">
                <label>Color</label>
                <ColorPicker Options="Colors" @bind-SelectedValue="Fund.Color" />
            </div>
        </div>

        <!-- Goal & Contributions -->
        <div class="form-section">
            <h3 class="section-title">Savings Goal</h3>
            
            <div class="form-group">
                <label>Goal Amount</label>
                <div class="input-with-prefix">
                    <span class="prefix">$</span>
                    <input type="number" @bind="Fund.GoalAmount" min="0" step="0.01" placeholder="0.00" />
                </div>
            </div>

            <div class="form-group">
                <label>Monthly Contribution</label>
                <div class="input-with-prefix">
                    <span class="prefix">$</span>
                    <input type="number" @bind="Fund.MonthlyContribution" min="0" step="0.01" placeholder="0.00" />
                </div>
                @if (Fund.MonthlyContribution > 0 && Fund.GoalAmount > 0)
                {
                    <div class="calc-helper">
                        You'll reach your goal in <strong>@CalculatedMonths months</strong> (@CalculatedDate.ToString("MMM yyyy"))
                    </div>
                }
            </div>

            @if (Fund.MonthlyContribution > 0)
            {
                <div class="form-group">
                    <div class="auto-contribute-toggle" @onclick="() => Fund.AutoContribute = !Fund.AutoContribute">
                        <div class="toggle-info">
                            <span class="toggle-label">Auto-contribute monthly</span>
                            <span class="toggle-description">Automatically add @Fund.MonthlyContribution.ToString("C0") at the start of each month</span>
                        </div>
                        <div class="toggle-switch @(Fund.AutoContribute ? "on" : "")">
                            <div class="toggle-knob"></div>
                        </div>
                    </div>
                </div>
            }

            <div class="form-row">
                <div class="form-group half">
                    <label>Start Date</label>
                    <input type="date" @bind="Fund.StartDate" />
                </div>
                <div class="form-group half">
                    <label>Target Date (optional)</label>
                    <input type="date" @bind="TargetDateValue" />
                </div>
            </div>

            @if (TargetDateValue.HasValue && Fund.GoalAmount > 0)
            {
                <div class="calc-helper target-calc">
                    To reach your goal by @TargetDateValue.Value.ToString("MMM yyyy"), save 
                    <strong>@RequiredMonthlyContribution.ToString("C0")/month</strong>
                    <button class="apply-btn" @onclick="ApplySuggestedContribution">Apply</button>
                </div>
            }
        </div>

        <!-- Status (for existing funds) -->
        @if (!IsNew)
        {
            <div class="form-section">
                <h3 class="section-title">Status</h3>
                
                <div class="status-options">
                    <button class="status-btn @(Fund.Status == SinkingFundStatus.Active ? "selected active" : "")"
                            @onclick="() => Fund.Status = SinkingFundStatus.Active">
                        <span class="status-icon">▶</span> Active
                    </button>
                    <button class="status-btn @(Fund.Status == SinkingFundStatus.Paused ? "selected paused" : "")"
                            @onclick="() => Fund.Status = SinkingFundStatus.Paused">
                        <span class="status-icon">⏸</span> Paused
                    </button>
                    <button class="status-btn @(Fund.Status == SinkingFundStatus.Completed ? "selected completed" : "")"
                            @onclick="() => Fund.Status = SinkingFundStatus.Completed">
                        <span class="status-icon">✓</span> Completed
                    </button>
                </div>

                @if (!IsNew)
                {
                    <div class="current-balance-info">
                        <span>Current Balance:</span>
                        <strong>@Fund.CurrentBalance.ToString("C2")</strong>
                    </div>
                }
            </div>
        }

        <!-- Actions -->
        <div class="form-actions">
            <button class="save-btn" @onclick="Save" disabled="@(!IsValid)">
                @(IsNew ? "Create Fund" : "Save Changes")
            </button>
            
            @if (!IsNew)
            {
                <button class="delete-btn" @onclick="Delete">Delete Fund</button>
            }
        </div>
    </div>
</div>
