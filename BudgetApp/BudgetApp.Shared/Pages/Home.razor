@page "/"

<PageTitle>Budget</PageTitle>

<div class="budget-app">
    <!-- Month Navigation -->
    <MonthNavigator CurrentDate="CurrentDate" OnPreviousMonth="PreviousMonth" OnNextMonth="NextMonth" />

    <!-- Income Summary Card -->
    <div class="summary-card">
        <!-- Expected Income Row (for budgeting) -->
        <div class="income-section">
            <div class="income-expected" @onclick="StartEditingExpectedIncome">
                <div class="income-label-row">
                    <span class="income-label">Expected Income</span>
                    <span class="edit-hint">âœŽ</span>
                </div>
                @if (IsEditingExpectedIncome)
                {
                    <div class="income-edit" @onclick:stopPropagation="true">
                        <span class="currency-prefix">$</span>
                        <input type="number" 
                               class="income-input" 
                               @bind="EditExpectedIncomeAmount" 
                               @bind:event="oninput"
                               step="100" 
                               min="0" />
                        <button class="save-btn" @onclick="SaveExpectedIncome">âœ“</button>
                        <button class="cancel-btn" @onclick="CancelEditExpectedIncome">âœ•</button>
                    </div>
                }
                else
                {
                    <span class="income-amount">@ExpectedIncome.ToString("C0")</span>
                }
            </div>
            
            <!-- Actual/Received Income -->
            <div class="income-actual" @onclick="OpenIncomeModal">
                <div class="income-label-row">
                    <span class="income-label received">Received</span>
                    <span class="edit-hint">+ Add</span>
                </div>
                <div class="income-received-group">
                    <span class="income-received-amount @(ActualIncome >= ExpectedIncome ? "complete" : "")">
                        @ActualIncome.ToString("C0")
                    </span>
                    <span class="income-status">
                        @if (ActualIncome >= ExpectedIncome && ExpectedIncome > 0)
                        {
                            <span class="status-complete">âœ“ All received</span>
                        }
                        else if (IncomeTransactionCount > 0)
                        {
                            <span>@IncomeTransactionCount paycheck@(IncomeTransactionCount != 1 ? "s" : "")</span>
                        }
                        else
                        {
                            <span class="status-pending">Awaiting paychecks</span>
                        }
                    </span>
                </div>
            </div>
        </div>

        <!-- Budget Allocation -->
        <div class="allocation-section">
            <div class="allocation-row">
                <span class="allocation-label">Budgeted</span>
                <span class="allocation-value">@TotalBudget.ToString("C0")</span>
            </div>
            <div class="allocation-row @(Unallocated < 0 ? "warning" : "success")">
                <span class="allocation-label">@(Unallocated >= 0 ? "Unallocated" : "Over budget by")</span>
                <span class="allocation-value">@Math.Abs(Unallocated).ToString("C0")</span>
            </div>
        </div>

        <!-- Spending Progress -->
        <div class="spending-section">
            <div class="spending-header">
                <span class="spending-label">Spent this month</span>
                <span class="spending-value @(TotalSpent > ExpectedIncome ? "over" : "")">
                    @TotalSpent.ToString("C0")
                </span>
            </div>
            <div class="progress-container">
                <div class="progress-bar @(TotalSpent > ExpectedIncome ? "over" : "")" style="width: @ProgressPercentage%"></div>
            </div>
            <div class="progress-label">
                <span>@RemainingIncome.ToString("C0") left of income</span>
                <span>@ProgressPercentage.ToString("0")% spent</span>
            </div>
        </div>
    </div>

    <!-- Fixed Expenses -->
    <ExpandableSection Icon="ðŸ“Œ" Title="Fixed Expenses" 
                      Summary="@($"{FixedSpent:C0} / {FixedBudget:C0}")" 
                      Count="FixedCategories.Count"
                      CssClass="fixed" @bind-IsExpanded="FixedExpanded">
        <div class="category-list">
            @foreach (var category in FixedCategories)
            {
                var catId = category.Id;
                var spent = BudgetService.GetSpentByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var budget = BudgetService.GetBudgetByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var percent = budget > 0 ? Math.Min((double)(spent / budget) * 100, 100) : 0;
                var isOver = spent > budget;

                <div class="category-item" @onclick="() => OpenCategory(catId)">
                    <div class="category-icon" style="background-color: @category.Color">@category.Icon</div>
                    <div class="category-info">
                        <div class="category-header">
                            <span class="category-name">@category.Name</span>
                            <span class="category-amount @(isOver ? "over" : "")">@spent.ToString("C0") / @budget.ToString("C0")</span>
                        </div>
                        <div class="category-progress-container">
                            <div class="category-progress-bar @(isOver ? "over" : "")" 
                                 style="width: @percent%; background-color: @category.Color"></div>
                        </div>
                    </div>
                    <span class="category-chevron">â€º</span>
                </div>
            }
            @if (FixedCategories.Count == 0)
            {
                <EmptyState Message="No fixed expense categories" />
            }
        </div>
    </ExpandableSection>

    <!-- Discretionary -->
    <ExpandableSection Icon="ðŸŽ¯" Title="Discretionary" 
                      Summary="@($"{DiscretionarySpent:C0} / {DiscretionaryBudget:C0}")" 
                      Count="DiscretionaryCategories.Count"
                      CssClass="discretionary" @bind-IsExpanded="DiscretionaryExpanded">
        <div class="category-list">
            @foreach (var category in DiscretionaryCategories)
            {
                var catId = category.Id;
                var spent = BudgetService.GetSpentByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var budget = BudgetService.GetBudgetByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var percent = budget > 0 ? Math.Min((double)(spent / budget) * 100, 100) : 0;
                var isOver = spent > budget;

                <div class="category-item" @onclick="() => OpenCategory(catId)">
                    <div class="category-icon" style="background-color: @category.Color">@category.Icon</div>
                    <div class="category-info">
                        <div class="category-header">
                            <span class="category-name">@category.Name</span>
                            <span class="category-amount @(isOver ? "over" : "")">@spent.ToString("C0") / @budget.ToString("C0")</span>
                        </div>
                        <div class="category-progress-container">
                            <div class="category-progress-bar @(isOver ? "over" : "")" 
                                 style="width: @percent%; background-color: @category.Color"></div>
                        </div>
                    </div>
                    <span class="category-chevron">â€º</span>
                </div>
            }
            @if (DiscretionaryCategories.Count == 0)
            {
                <EmptyState Message="No discretionary categories" />
            }
        </div>
    </ExpandableSection>

    <!-- Savings & Investments -->
    <ExpandableSection Icon="ðŸ“ˆ" Title="Savings & Investments" 
                      Summary="@($"{SavingsSpent:C0} / {SavingsBudget:C0}")" 
                      Count="SavingsCategories.Count"
                      CssClass="savings" @bind-IsExpanded="SavingsExpanded">
        <div class="category-list">
            @foreach (var category in SavingsCategories)
            {
                var catId = category.Id;
                var spent = BudgetService.GetSpentByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var budget = BudgetService.GetBudgetByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                var percent = budget > 0 ? Math.Min((double)(spent / budget) * 100, 100) : 0;
                var isOver = spent > budget;

                <div class="category-item" @onclick="() => OpenCategory(catId)">
                    <div class="category-icon" style="background-color: @category.Color">@category.Icon</div>
                    <div class="category-info">
                        <div class="category-header">
                            <span class="category-name">@category.Name</span>
                            <span class="category-amount @(isOver ? "over" : "")">@spent.ToString("C0") / @budget.ToString("C0")</span>
                        </div>
                        <div class="category-progress-container">
                            <div class="category-progress-bar @(isOver ? "over" : "")" 
                                 style="width: @percent%; background-color: @category.Color"></div>
                        </div>
                    </div>
                    <span class="category-chevron">â€º</span>
                </div>
            }
            @if (SavingsCategories.Count == 0)
            {
                <EmptyState Message="No savings categories.">
                    <a href="/categories">Add one!</a>
                </EmptyState>
            }
        </div>
    </ExpandableSection>

    <!-- Sinking Funds -->
    @if (SinkingFunds.Any())
    {
        <ExpandableSection Icon="ðŸ’°" Title="Sinking Funds" 
                          Summary="@($"{TotalSaved:C0} / {TotalGoal:C0}")" 
                          Count="ActiveFunds.Count()"
                          CssClass="sinking-funds" @bind-IsExpanded="SinkingFundsExpanded">
            <div class="sinking-funds-list">
                @foreach (var fund in ActiveFunds)
                {
                    <div class="fund-item" @onclick="() => OpenFund(fund.Id)">
                        <div class="fund-icon" style="background-color: @fund.Color">@fund.Icon</div>
                        <div class="fund-info">
                            <div class="fund-header">
                                <span class="fund-name">@fund.Name</span>
                                <span class="fund-amount">@fund.CurrentBalance.ToString("C0") / @fund.GoalAmount.ToString("C0")</span>
                            </div>
                            <div class="fund-progress-container">
                                <div class="fund-progress-bar" 
                                     style="width: @fund.ProgressPercentage%; background-color: @fund.Color"></div>
                            </div>
                            <div class="fund-meta">
                                @if (fund.MonthlyContribution > 0)
                                {
                                    <span class="fund-contribution">@fund.MonthlyContribution.ToString("C0")/mo</span>
                                }
                                @if (fund.MonthsRemaining > 0)
                                {
                                    <span class="fund-remaining">@fund.MonthsRemaining mo left</span>
                                }
                                @if (fund.AutoContribute)
                                {
                                    <span class="fund-auto-badge">Auto</span>
                                }
                            </div>
                        </div>
                        <span class="fund-chevron">â€º</span>
                    </div>
                }
            </div>
        </ExpandableSection>
    }

    <!-- Recent Transactions -->
    <div class="section">
        <div class="section-header">
            <span class="section-title">Recent Transactions</span>
        </div>
        <div class="transaction-list">
            @foreach (var transaction in RecentTransactions.Take(5))
            {
                var category = Categories.FirstOrDefault(c => c.Id == transaction.CategoryId);
                var isIncome = transaction.Type == TransactionType.Income;

                <TransactionListItem Icon="@(category?.Icon ?? "ðŸ’°")" 
                                    IconColor="@(category?.Color ?? "#6B7280")"
                                    Description="@transaction.Description"
                                    Date="transaction.Date"
                                    Amount="transaction.Amount"
                                    IsIncome="isIncome" />
            }
        </div>
    </div>

    <!-- Spacer for floating button -->
    <div class="bottom-spacer"></div>

    <!-- Floating Add Button -->
    <FloatingActionButton Label="Add Transaction" OnClick="OpenAddTransaction" />
</div>

<!-- Paycheck Modal -->
<ModalBase IsVisible="ShowPaycheckModal" OnClose="ClosePaycheckModal" Title="ðŸ’µ Add Paycheck">
    <Body>
        <!-- Description -->
        <div class="form-group">
            <label class="form-label">Description</label>
            <input type="text" 
                   class="form-input" 
                   placeholder="e.g., Company ABC Salary"
                   @bind="PaycheckDescription" />
        </div>
        
        <!-- Amount -->
        <div class="form-group">
            <label class="form-label">Amount</label>
            <div class="amount-input-group">
                <span class="currency-symbol">$</span>
                <input type="number" 
                       class="form-input amount" 
                       placeholder="0.00"
                       step="0.01"
                       min="0"
                       @bind="PaycheckAmount" />
            </div>
        </div>
        
        <!-- Recurring Toggle -->
        <div class="form-group">
            <div class="toggle-row" @onclick="() => IsRecurringPaycheck = !IsRecurringPaycheck">
                <div class="toggle-label">
                    <span class="toggle-icon">ðŸ”„</span>
                    <span>Recurring paycheck</span>
                </div>
                <div class="toggle-switch @(IsRecurringPaycheck ? "active" : "")">
                    <div class="toggle-knob"></div>
                </div>
            </div>
        </div>
        
        @if (IsRecurringPaycheck)
        {
            <!-- Frequency -->
            <div class="form-group">
                <label class="form-label">Frequency</label>
                <select class="form-input" @bind="PaycheckFrequency">
                    <option value="@RecurrenceFrequency.Weekly">Weekly</option>
                    <option value="@RecurrenceFrequency.Biweekly">Every 2 weeks</option>
                    <option value="@RecurrenceFrequency.Monthly">Monthly</option>
                </select>
            </div>
            
            <!-- Day of Month (for monthly) -->
            @if (PaycheckFrequency == RecurrenceFrequency.Monthly)
            {
                <div class="form-group">
                    <label class="form-label">Pay day</label>
                    <select class="form-input" @bind="PaycheckDayOfMonth">
                        @for (int i = 1; i <= 28; i++)
                        {
                            <option value="@i">@DateHelpers.GetOrdinal(i) of each month</option>
                        }
                        <option value="31">Last day of month</option>
                    </select>
                </div>
            }
            else
            {
                <!-- Start date for weekly/biweekly -->
                <div class="form-group">
                    <label class="form-label">Next pay date</label>
                    <input type="date" 
                           class="form-input"
                           @bind="PaycheckDate" />
                </div>
            }
            
            <div class="recurring-hint">
                <span class="hint-icon">ðŸ’¡</span>
                <span>This paycheck will automatically appear each @GetFrequencyText()</span>
            </div>
        }
        else
        {
            <!-- One-time date -->
            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" 
                       class="form-input"
                       @bind="PaycheckDate" />
            </div>
        }
        
        <!-- This Month's Paychecks -->
        @if (RecentPaychecks.Any() || RecurringPaychecks.Any())
        {
            <div class="recent-paychecks">
                <label class="form-label">This Month's Income</label>
                <div class="paycheck-list">
                    @foreach (var paycheck in RecentPaychecks)
                    {
                        var paycheckId = paycheck.Id;
                        <div class="paycheck-item">
                            <div class="paycheck-info">
                                <span class="paycheck-desc">@paycheck.Description</span>
                                <span class="paycheck-date">@paycheck.Date.ToString("MMM d")</span>
                            </div>
                            <span class="paycheck-amount">+@paycheck.Amount.ToString("C2")</span>
                            <button class="paycheck-delete" @onclick="() => DeletePaycheck(paycheckId)">âœ•</button>
                        </div>
                    }
                </div>
                
                @if (RecurringPaychecks.Any())
                {
                    <div class="recurring-section">
                        <span class="recurring-label">ðŸ”„ Recurring Paychecks</span>
                        <div class="paycheck-list">
                            @foreach (var recurring in RecurringPaychecks)
                            {
                                var recurringId = recurring.Id;
                                <div class="paycheck-item recurring">
                                    <div class="paycheck-info">
                                        <span class="paycheck-desc">@recurring.Description</span>
                                        <span class="paycheck-date">@GetFrequencyLabel(recurring)</span>
                                    </div>
                                    <span class="paycheck-amount">+@recurring.Amount.ToString("C2")</span>
                                    <button class="paycheck-delete" @onclick="() => DeleteRecurringPaycheck(recurringId)">âœ•</button>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </Body>
    <Footer>
        <button class="btn-cancel" @onclick="ClosePaycheckModal">Cancel</button>
        <button class="btn-save" @onclick="SavePaycheck" disabled="@(!IsPaycheckValid)">
            @(IsRecurringPaycheck ? "Set Up Recurring" : "Add Paycheck")
        </button>
    </Footer>
</ModalBase>
