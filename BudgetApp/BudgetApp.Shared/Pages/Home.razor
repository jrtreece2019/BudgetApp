@page "/"
@inject IBudgetService BudgetService
@inject NavigationManager Navigation

<PageTitle>Budget</PageTitle>

<div class="budget-app">
    <!-- Month Navigation -->
    <div class="month-nav">
        <button class="month-btn" @onclick="PreviousMonth">‹</button>
        <span class="month-title">@CurrentDate.ToString("MMMM yyyy")</span>
        <button class="month-btn" @onclick="NextMonth">›</button>
    </div>

    <!-- Income Summary Card -->
    <div class="summary-card">
        <!-- Income Row -->
        <div class="income-row" @onclick="StartEditingIncome">
            <div class="income-label">
                Monthly Income
                <span class="edit-hint">✎</span>
            </div>
            @if (IsEditingIncome)
            {
                <div class="income-edit" @onclick:stopPropagation="true">
                    <span class="currency-prefix">$</span>
                    <input type="number" 
                           class="income-input" 
                           @bind="EditIncomeAmount" 
                           @bind:event="oninput"
                           step="100" 
                           min="0" />
                    <button class="save-btn" @onclick="SaveIncome">✓</button>
                    <button class="cancel-btn" @onclick="CancelEditIncome">✕</button>
                </div>
            }
            else
            {
                <div class="income-amount">@MonthlyIncome.ToString("C0")</div>
            }
        </div>

        <!-- Budget Allocation -->
        <div class="allocation-section">
            <div class="allocation-row">
                <span class="allocation-label">Budgeted</span>
                <span class="allocation-value">@TotalBudget.ToString("C0")</span>
            </div>
            <div class="allocation-row @(Unallocated < 0 ? "warning" : "success")">
                <span class="allocation-label">@(Unallocated >= 0 ? "Unallocated" : "Over budget by")</span>
                <span class="allocation-value">@Math.Abs(Unallocated).ToString("C0")</span>
            </div>
        </div>

        <!-- Spending Progress -->
        <div class="spending-section">
            <div class="spending-header">
                <span class="spending-label">Spent this month</span>
                <span class="spending-value @(TotalSpent > MonthlyIncome ? "over" : "")">
                    @TotalSpent.ToString("C0")
                </span>
            </div>
            <div class="progress-container">
                <div class="progress-bar @(TotalSpent > MonthlyIncome ? "over" : "")" style="width: @ProgressPercentage%"></div>
            </div>
            <div class="progress-label">
                <span>@RemainingIncome.ToString("C0") left of income</span>
                <span>@ProgressPercentage.ToString("0")% spent</span>
            </div>
        </div>
    </div>

    <!-- Fixed Expenses -->
    <div class="section">
        <div class="section-header-group" @onclick="() => FixedExpanded = !FixedExpanded">
            <div class="section-header-left">
                <span class="section-expand-icon">@(FixedExpanded ? "▼" : "▶")</span>
                <span class="section-type-icon">📌</span>
                <span class="section-title">Fixed Expenses</span>
            </div>
            <div class="section-header-right">
                <span class="section-summary">@FixedSpent.ToString("C0") / @FixedBudget.ToString("C0")</span>
                <span class="section-count">@FixedCategories.Count</span>
            </div>
        </div>
        @if (FixedExpanded)
        {
            <div class="category-list">
                @foreach (var category in FixedCategories)
                {
                    var catId = category.Id;
                    var spent = BudgetService.GetSpentByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                    var budget = BudgetService.GetBudgetByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                    var percent = budget > 0 ? Math.Min((double)(spent / budget) * 100, 100) : 0;
                    var isOver = spent > budget;

                    <div class="category-item" @onclick="() => OpenCategory(catId)">
                        <div class="category-icon" style="background-color: @category.Color">@category.Icon</div>
                        <div class="category-info">
                            <div class="category-header">
                                <span class="category-name">@category.Name</span>
                                <span class="category-amount @(isOver ? "over" : "")">@spent.ToString("C0") / @budget.ToString("C0")</span>
                            </div>
                            <div class="category-progress-container">
                                <div class="category-progress-bar @(isOver ? "over" : "")" 
                                     style="width: @percent%; background-color: @category.Color"></div>
                            </div>
                        </div>
                        <span class="category-chevron">›</span>
                    </div>
                }
                @if (FixedCategories.Count == 0)
                {
                    <div class="empty-state">
                        <span class="empty-text">No fixed expense categories</span>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Discretionary -->
    <div class="section">
        <div class="section-header-group" @onclick="() => DiscretionaryExpanded = !DiscretionaryExpanded">
            <div class="section-header-left">
                <span class="section-expand-icon">@(DiscretionaryExpanded ? "▼" : "▶")</span>
                <span class="section-type-icon">🎯</span>
                <span class="section-title">Discretionary</span>
            </div>
            <div class="section-header-right">
                <span class="section-summary">@DiscretionarySpent.ToString("C0") / @DiscretionaryBudget.ToString("C0")</span>
                <span class="section-count">@DiscretionaryCategories.Count</span>
            </div>
        </div>
        @if (DiscretionaryExpanded)
        {
            <div class="category-list">
                @foreach (var category in DiscretionaryCategories)
                {
                    var catId = category.Id;
                    var spent = BudgetService.GetSpentByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                    var budget = BudgetService.GetBudgetByCategory(category.Id, CurrentDate.Month, CurrentDate.Year);
                    var percent = budget > 0 ? Math.Min((double)(spent / budget) * 100, 100) : 0;
                    var isOver = spent > budget;

                    <div class="category-item" @onclick="() => OpenCategory(catId)">
                        <div class="category-icon" style="background-color: @category.Color">@category.Icon</div>
                        <div class="category-info">
                            <div class="category-header">
                                <span class="category-name">@category.Name</span>
                                <span class="category-amount @(isOver ? "over" : "")">@spent.ToString("C0") / @budget.ToString("C0")</span>
                            </div>
                            <div class="category-progress-container">
                                <div class="category-progress-bar @(isOver ? "over" : "")" 
                                     style="width: @percent%; background-color: @category.Color"></div>
                            </div>
                        </div>
                        <span class="category-chevron">›</span>
                    </div>
                }
                @if (DiscretionaryCategories.Count == 0)
                {
                    <div class="empty-state">
                        <span class="empty-text">No discretionary categories</span>
                    </div>
                }
            </div>
        }
    </div>

    <!-- Recent Transactions -->
    <div class="section">
        <div class="section-header">
            <span class="section-title">Recent Transactions</span>
        </div>
        <div class="transaction-list">
            @foreach (var transaction in RecentTransactions.Take(5))
            {
                var category = Categories.FirstOrDefault(c => c.Id == transaction.CategoryId);
                var isIncome = transaction.Type == TransactionType.Income;

                <div class="transaction-item">
                    <div class="transaction-icon" style="background-color: @(category?.Color ?? "#6B7280")">
                        @(category?.Icon ?? "💰")
                    </div>
                    <div class="transaction-info">
                        <span class="transaction-desc">@transaction.Description</span>
                        <span class="transaction-date">@FormatDate(transaction.Date)</span>
                    </div>
                    <div class="transaction-amount @(isIncome ? "income" : "expense")">
                        @(isIncome ? "+" : "-")@transaction.Amount.ToString("C2")
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Spacer for floating button -->
    <div class="bottom-spacer"></div>

    <!-- Floating Add Button -->
    <button class="fab" @onclick="OpenAddTransaction">
        <span class="fab-icon">+</span>
        <span class="fab-text">Add Transaction</span>
    </button>
</div>

@code {
    private DateTime CurrentDate { get; set; } = DateTime.Now;
    private List<Category> Categories { get; set; } = new();
    private List<Transaction> RecentTransactions { get; set; } = new();
    private decimal MonthlyIncome { get; set; }
    private decimal TotalBudget { get; set; }
    private decimal TotalSpent { get; set; }
    private decimal RemainingBudget => TotalBudget - TotalSpent;
    private decimal Unallocated => MonthlyIncome - TotalBudget;
    private decimal RemainingIncome => MonthlyIncome - TotalSpent;
    private double ProgressPercentage => MonthlyIncome > 0 ? Math.Min((double)(TotalSpent / MonthlyIncome) * 100, 100) : 0;
    
    // Income editing
    private bool IsEditingIncome { get; set; }
    private decimal EditIncomeAmount { get; set; }
    
    // Grouped categories
    private List<Category> FixedCategories => Categories.Where(c => c.Type == CategoryType.Fixed).ToList();
    private List<Category> DiscretionaryCategories => Categories.Where(c => c.Type == CategoryType.Discretionary).ToList();
    
    // Section expand state
    private bool FixedExpanded { get; set; } = true;
    private bool DiscretionaryExpanded { get; set; } = true;
    
    // Group totals
    private decimal FixedBudget { get; set; }
    private decimal FixedSpent { get; set; }
    private decimal DiscretionaryBudget { get; set; }
    private decimal DiscretionarySpent { get; set; }

    protected override void OnInitialized()
    {
        // Check for month/year query parameters (when returning from category detail)
        var uri = new Uri(Navigation.Uri);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            if (int.TryParse(queryParams["month"], out var month) && 
                int.TryParse(queryParams["year"], out var year))
            {
                CurrentDate = new DateTime(year, month, 1);
            }
        }

        // Process any pending recurring transactions
        BudgetService.ProcessRecurringTransactions();
        
        LoadData();
    }

    private void LoadData()
    {
        Categories = BudgetService.GetCategories();
        RecentTransactions = BudgetService.GetTransactions(CurrentDate.Month, CurrentDate.Year);
        MonthlyIncome = BudgetService.GetMonthlyIncome();
        TotalBudget = BudgetService.GetTotalBudget(CurrentDate.Month, CurrentDate.Year);
        TotalSpent = BudgetService.GetTotalSpent(CurrentDate.Month, CurrentDate.Year);
        
        // Calculate group totals
        FixedBudget = FixedCategories.Sum(c => BudgetService.GetBudgetByCategory(c.Id, CurrentDate.Month, CurrentDate.Year));
        FixedSpent = FixedCategories.Sum(c => BudgetService.GetSpentByCategory(c.Id, CurrentDate.Month, CurrentDate.Year));
        DiscretionaryBudget = DiscretionaryCategories.Sum(c => BudgetService.GetBudgetByCategory(c.Id, CurrentDate.Month, CurrentDate.Year));
        DiscretionarySpent = DiscretionaryCategories.Sum(c => BudgetService.GetSpentByCategory(c.Id, CurrentDate.Month, CurrentDate.Year));
    }

    // Income editing
    private void StartEditingIncome()
    {
        if (!IsEditingIncome)
        {
            EditIncomeAmount = MonthlyIncome;
            IsEditingIncome = true;
        }
    }

    private void SaveIncome()
    {
        if (EditIncomeAmount >= 0)
        {
            BudgetService.SetMonthlyIncome(EditIncomeAmount);
            LoadData();
        }
        IsEditingIncome = false;
    }

    private void CancelEditIncome()
    {
        IsEditingIncome = false;
    }

    private void PreviousMonth()
    {
        CurrentDate = CurrentDate.AddMonths(-1);
        LoadData();
    }

    private void NextMonth()
    {
        CurrentDate = CurrentDate.AddMonths(1);
        LoadData();
    }

    private void OpenAddTransaction()
    {
        Navigation.NavigateTo("/add");
    }

    private void OpenCategory(int categoryId)
    {
        Navigation.NavigateTo($"/category/{categoryId}/{CurrentDate.Month}/{CurrentDate.Year}");
    }

    private string FormatDate(DateTime date)
    {
        if (date.Date == DateTime.Today)
            return "Today";
        if (date.Date == DateTime.Today.AddDays(-1))
            return "Yesterday";
        return date.ToString("MMM d");
    }
}
